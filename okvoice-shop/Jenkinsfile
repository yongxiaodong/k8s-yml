pipeline {
    agent {
    node {
        label 'jenkinsbuildnode'
        }
    }
   environment {
	   git_url = 'http://47.101.131.117:3000/okvoice/okvoice-shop.git'
       docker_registry = '172.26.112.47'
       docker_registry_item = 'okvoice-shop'
	   image_name = "${docker_registry_item}"
       docker_image_fqdn = '${docker_registry}/${docker_registry_item}/${image_name}:${BUILD_ID}'
   }
    stages {

		stage('Pull code') {
			steps {
			dir('./project') {
				git branch: '${branch_name}', credentialsId: '09267d83-3027-4ac5-a940-e0e61757e48a', url: "${git_url}"
				sh "/bin/cp -fR ../${JOB_NAME}/* ./"
			}
			}
		}
		
	  stage('get_commit_msg') {
		 steps {
			script {
			   env.GIT_COMMIT_MSG = sh (script: 'git log -1 --pretty=%B ${GIT_COMMIT}', returnStdout: true).trim()
			}
		}
	  }
	  stage('mvn') {
					//  when {
			//     changelog '.*$'
			//     }
				steps {
				script {
					if ( skip == 'no' ) {
					dir('./project') {
					sh '''
					mvn -B -DskipTests clean package
					'''
				}
				}
				}
			}

		}
		stage('build docker image') {
			steps {
				dir('./project') {
				sh 'sed -i "s/^.*ENV PROFILES_ACTIVE.*$/ENV PROFILES_ACTIVE ${PROFILES_ACTIVE_VALUE}/g" prd_Dockerfile'
				sh """
				docker build -t  ${docker_image_fqdn} -f prd_Dockerfile  .
				docker login -u admin -p okvoice ${docker_registry}
				docker push ${docker_image_fqdn}
				docker rmi ${docker_image_fqdn}
				"""
			}
			}
		}
		stage('deploy') {
			steps {
				dir('./project') {
				sh 'sed -i "s/replicas:.*/replicas: ${replicas_count}/g" deploy.yml'
				sh 'sed -i "s/\\(^.*image: \\)\\(.*$\\)/\\1${docker_registry}\\/${docker_registry_item}\\/${image_name}:${BUILD_ID}/g" deploy.yml'
				kubernetesDeploy configs: 'deploy.yml', kubeConfig: [path: ''], kubeconfigId: 'e94c584f-510a-4b20-be41-eda4a9b35770', secretName: '', ssh: [sshCredentialsId: '*', sshServer: ''], textCredentials: [certificateAuthorityData: '', clientCertificateData: '', clientKeyData: '', serverUrl: 'https://']
			}
			}
		}


	}
}

